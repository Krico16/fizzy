#!/usr/bin/env bash
set -e

echo "üöÄ Fizzy Production Deployment"
echo "================================"

# Check if .env.production exists
if [ ! -f .env.production ]; then
    echo "‚ùå Error: .env.production file not found!"
    echo "Please create .env.production from .env.production.example"
    exit 1
fi

# Load environment variables
export $(cat .env.production | grep -v '^#' | xargs)

# Check required variables
REQUIRED_VARS=("RAILS_MASTER_KEY" "SECRET_KEY_BASE")
for var in "${REQUIRED_VARS[@]}"; do
    if [ -z "${!var}" ]; then
        echo "‚ùå Error: $var is not set in .env.production"
        exit 1
    fi
done

echo "‚úì Environment variables loaded"

# Build the production image
echo ""
echo "üì¶ Building production image..."
docker compose -f docker-compose.prod.yml build --no-cache

echo ""
echo "‚úì Image built successfully"

# Stop existing containers
echo ""
echo "üõë Stopping existing containers..."
docker compose -f docker-compose.prod.yml down

# Start new containers
echo ""
echo "üöÄ Starting production containers..."
docker compose -f docker-compose.prod.yml up -d

# Wait for health check
echo ""
echo "‚è≥ Waiting for application to be healthy..."
sleep 10

# Check health
if docker compose -f docker-compose.prod.yml ps | grep -q "healthy"; then
    echo ""
    echo "‚úÖ Deployment successful!"
    echo ""
    echo "Application is running at: http://localhost"
    echo "Logs: docker compose -f docker-compose.prod.yml logs -f"
    echo "Stop: docker compose -f docker-compose.prod.yml down"
else
    echo ""
    echo "‚ö†Ô∏è  Application started but health check pending..."
    echo "Check logs with: docker compose -f docker-compose.prod.yml logs -f"
fi
